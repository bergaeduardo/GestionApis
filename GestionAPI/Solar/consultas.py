qry_ventasEnc =  '''
    SELECT
    CONVERT(VARCHAR, FECHA_EMIS, 105) AS Fecha, -- Convierte a formato 'dd-mm-yyyy'
	CONVERT(VARCHAR(8), HORA_EMIS, 108) AS Hora,
    CASE
        WHEN T_COMP + '-' + SUBSTRING(N_COMP,1,1) = 'FAC-A' THEN '001'
        WHEN T_COMP + '-' + SUBSTRING(N_COMP,1,1) = 'FAC-B' THEN '006'
        WHEN T_COMP + '-' + SUBSTRING(N_COMP,1,1) = 'NCR-A' THEN '003'
        WHEN T_COMP + '-' + SUBSTRING(N_COMP,1,1) = 'NCR-B' THEN '008'
        WHEN T_COMP + '-' + SUBSTRING(N_COMP,1,1) = 'NCP-A' THEN '003'
        WHEN T_COMP + '-' + SUBSTRING(N_COMP,1,1) = 'NCP-B' THEN '008'
    END AS IdComprobante,
    '0001' AS PtoVenta,
    N_COMP AS NroComprobante,
    MEDIO_DE_PAGO AS MedioPago,
    CONVERT(DECIMAL(18, 2),IMPORTE) AS Importe
    FROM EB_T_HistorialSincVentas_Solar
    where ESTADO_SYNC = 0
'''

qry_ventasDetalle =  '''
--DECLARE @NCOMP VARCHAR(20) = 'B0021500030430'
 select * from (
	SELECT 
 	CTA02.N_COMP AS 'Comprobante' ,
 	CTA03.FECHA_MOV AS 'Enc.Fecha' ,
 	SUBSTRING(cta02.HORA_EMIS, 1, 2) + ':' + SUBSTRING(cta02.HORA_EMIS, 3, 2) + ':' + SUBSTRING(cta02.HORA_EMIS, 5, 2) AS 'Enc.HoraEmision' ,
 	CTA02.T_COMP AS 'Enc.Tipo' ,
 	CTA02.NRO_SUCURS AS 'Enc.Sucursal' ,
 	CTA_ARTICULO.DESC_CTA_ARTICULO AS 'Detalle.Descripcion' ,
 	CTA03.Cod_Articu AS 'Detalle.CodArticulo' ,
 	cast(SUM(CASE CTA03.TCOMP_IN_V WHEN 'CC' THEN (-1) ELSE (1) END * CTA03.CANTIDAD)as int )AS 'Detalle.Cantidad' ,
 	cast(CONVERT(DECIMAL(18, 2), CTA03.PRECIO_NET)as float) AS 'Detalle.ImporteNeto' ,
 	cast(CTA03.PORC_DTO as float) AS 'Detalle.PORC_DTO' ,
 	cast(CTA_ARTICULO.COMISION_V as float) AS 'Detalle.ComisionXVta' ,
 	cast(CTA_ARTICULO.DESCUENTO as float) AS 'Detalle.PorcentajeDescuento' ,
 	CTA_MEDIDA.SIGLA_MEDIDA AS 'Detalle.UnidadDeVentas' ,
 	CONVERT(DECIMAL(18, 2), (SUM( CASE WHEN CTA02.TCOMP_IN_V = 'CC' then (-1) ELSE (1) END *  CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN   (CASE CTA02.MON_CTE WHEN 1 THEN CASE 'NO' WHEN 'NO'                                   THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD)                                    ELSE CASE CTA02.IMPORTE WHEN 0 THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD)                                        ELSE ((CTA03.PRECIO_NET * CTA03.CANTIDAD) - ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_BONIF/100) +                                        ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CTA02.IMPORTE_FL/(CTA02.IMPORTE-CTA02.IMPORTE_FL+CTA02.IMPORTE_BO-CTA02.IMPORTE_IV-CTA02.IMPORTE_IN-ISNULL(IMPUESTOS.IMPORTE,0)))) + ((CTA03.PRECIO_NET * CTA03.CANTIDAD)                                        * CTA02.PORC_RECARGO/100))  END END                                  ELSE CASE 'NO' WHEN 'NO'                                   THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.COTIZ                                     ELSE CASE CTA02.IMPORTE WHEN 0 THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.COTIZ                                        ELSE ((CTA03.PRECIO_NET * CTA03.CANTIDAD) - ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_BONIF/100) +                                        ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CTA02.IMPORTE_FL/(CTA02.IMPORTE-CTA02.IMPORTE_FL+CTA02.IMPORTE_BO-CTA02.IMPORTE_IV-CTA02.IMPORTE_IN-ISNULL(IMPUESTOS.IMPORTE,0)))) + ((CTA03.PRECIO_NET * CTA03.CANTIDAD)                                        * CTA02.PORC_RECARGO/100))  * CTA02.COTIZ END END                             END)  WHEN 'BIORIGEN' THEN   (CASE CTA02.MON_CTE WHEN 1 THEN CASE CTA02.COTIZ WHEN 0                                   THEN 0                                   ELSE CASE 'NO' WHEN 'NO'                                        THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD)   / CTA02.COTIZ                                         ELSE CASE CTA02.IMPORTE WHEN 0 THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD)/ CTA02.COTIZ                                              ELSE ((CTA03.PRECIO_NET * CTA03.CANTIDAD) - ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_BONIF/100) +                                                           ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CTA02.IMPORTE_FL/(CTA02.IMPORTE-CTA02.IMPORTE_FL+CTA02.IMPORTE_BO-CTA02.IMPORTE_IV-CTA02.IMPORTE_IN-ISNULL(IMPUESTOS.IMPORTE,0))))                                                           + ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_RECARGO/100))  / CTA02.COTIZ END END                                        END                                   ELSE CASE 'NO' WHEN 'NO'                                   THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD)                                    ELSE CASE CTA02.IMPORTE WHEN 0 THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD)                                        ELSE ((CTA03.PRECIO_NET * CTA03.CANTIDAD) - ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_BONIF/100) +                                                           ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CTA02.IMPORTE_FL/(CTA02.IMPORTE-CTA02.IMPORTE_FL+CTA02.IMPORTE_BO-CTA02.IMPORTE_IV-CTA02.IMPORTE_IN-ISNULL(IMPUESTOS.IMPORTE,0)))) +                                                           ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_RECARGO/100))  END END                              END)  WHEN 'BICOTIZ'  THEN CASE 1  WHEN 0 THEN 0  ELSE   (CASE CTA02.MON_CTE WHEN 1 THEN CASE 'NO' WHEN 'NO'                                THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD)  / 1                                ELSE CASE CTA02.IMPORTE WHEN 0 THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD)  / 1                                      ELSE ((CTA03.PRECIO_NET * CTA03.CANTIDAD) - ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_BONIF/100) +                                     ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CTA02.IMPORTE_FL/(CTA02.IMPORTE-CTA02.IMPORTE_FL+CTA02.IMPORTE_BO-CTA02.IMPORTE_IV-CTA02.IMPORTE_IN-ISNULL(IMPUESTOS.IMPORTE,0)))) +                                     ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_RECARGO/100))                                                           / 1 END END                             ELSE CASE 'NO' WHEN 'NO'                              THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.COTIZ  / 1                                ELSE CASE CTA02.IMPORTE WHEN 0 THEN  (CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.COTIZ  / 1                                     ELSE ((CTA03.PRECIO_NET * CTA03.CANTIDAD) - ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_BONIF/100) +                                             ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CTA02.IMPORTE_FL/(CTA02.IMPORTE-CTA02.IMPORTE_FL+CTA02.IMPORTE_BO-CTA02.IMPORTE_IV-CTA02.IMPORTE_IN-ISNULL(IMPUESTOS.IMPORTE,0)))) +                                              ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_RECARGO/100)) * CTA02.COTIZ  / 1   END END                              END)  END END      )))  AS 'Detalle.Importe' ,
 	CONVERT(DECIMAL(18, 2), CASE CTA03.TCOMP_IN_V WHEN 'CC' THEN ( -1 )ELSE ( 1 ) END * CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN CASE CTA02.MON_CTE  WHEN 1 THEN CTA03.PRECIO_NET * (CASE WHEN CTA02.IMPORTE_IV = 0 THEN 1 ELSE ( 1 + (CTA03.PORC_IVA/100)) END) ELSE  CTA03.PRECIO_NET * (CASE WHEN CTA02.IMPORTE_IV = 0 THEN 1 ELSE ( 1 + (CTA03.PORC_IVA/100)) END) * CTA02.COTIZ  END WHEN 'BIORIGEN' THEN CASE CTA02.MON_CTE  WHEN 1 THEN CASE CTA02.COTIZ WHEN 0 THEN 0 ELSE CTA03.PRECIO_NET  * (CASE WHEN CTA02.IMPORTE_IV = 0 THEN 1 ELSE ( 1 + (CTA03.PORC_IVA/100)) END) /CTA02.COTIZ END ELSE CTA03.PRECIO_NET  * (CASE WHEN CTA02.IMPORTE_IV = 0 THEN 1 ELSE ( 1 + (CTA03.PORC_IVA/100)) END) END WHEN 'BICOTIZ' THEN CASE 1 WHEN 0 THEN 0 ELSE CASE CTA02.MON_CTE WHEN 1 THEN  CTA03.PRECIO_NET * (CASE WHEN CTA02.IMPORTE_IV = 0 THEN 1 ELSE ( 1 + (CTA03.PORC_IVA/100)) END) ELSE CTA03.PRECIO_NET *  (CASE WHEN CTA02.IMPORTE_IV = 0 THEN 1 ELSE ( 1 + (CTA03.PORC_IVA/100)) END) * CTA02.COTIZ END / 1 END END )   AS 'Detalle.PrecioConIVA' ,
 	CONVERT(DECIMAL(18, 2), SUM (CASE CTA03.TCOMP_IN_V WHEN 'CC' THEN (-1) ELSE (1) END *      CASE  'BIMONCTE'          WHEN 'BIMONCTE' THEN  CASE CTA02.MON_CTE  WHEN 1 THEN CTA03.IMP_NETO_P * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END) ELSE  CTA03.IMP_NETO_P * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END) * CTA02.COTIZ END           WHEN 'BIORIGEN' THEN  CASE CTA02.MON_CTE  WHEN 1 THEN CASE CTA02.COTIZ WHEN 0 THEN 0 ELSE CTA03.IMP_NETO_P * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END) / CTA02.COTIZ END ELSE CTA03.IMP_NETO_P * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END) END           WHEN 'BICOTIZ' THEN  CASE 1 WHEN 0 THEN 0 ELSE  CASE CTA02.MON_CTE  WHEN 1 THEN CTA03.IMP_NETO_P * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END) / 1 ELSE CTA03.IMP_NETO_P * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END) * CTA02.COTIZ / 1 END END END - CASE WHEN CTA02.TCOMP_IN_V = 'CC' then (-1) ELSE (1) END *  CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN   (CASE CTA02.MON_CTE WHEN 1 THEN CASE 'NO' WHEN 'NO'                                   THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD)                                    ELSE CASE CTA02.IMPORTE WHEN 0 THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD)                                        ELSE ((CTA03.PRECIO_NET * CTA03.CANTIDAD) - ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_BONIF/100) +                                        ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CTA02.IMPORTE_FL/(CTA02.IMPORTE-CTA02.IMPORTE_FL+CTA02.IMPORTE_BO-CTA02.IMPORTE_IV-CTA02.IMPORTE_IN-ISNULL(IMPUESTOS.IMPORTE,0)))) + ((CTA03.PRECIO_NET * CTA03.CANTIDAD)                                        * CTA02.PORC_RECARGO/100))  END END                                  ELSE CASE 'NO' WHEN 'NO'                                   THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.COTIZ                                     ELSE CASE CTA02.IMPORTE WHEN 0 THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.COTIZ                                        ELSE ((CTA03.PRECIO_NET * CTA03.CANTIDAD) - ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_BONIF/100) +                                        ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CTA02.IMPORTE_FL/(CTA02.IMPORTE-CTA02.IMPORTE_FL+CTA02.IMPORTE_BO-CTA02.IMPORTE_IV-CTA02.IMPORTE_IN-ISNULL(IMPUESTOS.IMPORTE,0)))) + ((CTA03.PRECIO_NET * CTA03.CANTIDAD)                                        * CTA02.PORC_RECARGO/100))  * CTA02.COTIZ END END                             END)  WHEN 'BIORIGEN' THEN   (CASE CTA02.MON_CTE WHEN 1 THEN CASE CTA02.COTIZ WHEN 0                                   THEN 0                                   ELSE CASE 'NO' WHEN 'NO'                                        THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD)   / CTA02.COTIZ                                         ELSE CASE CTA02.IMPORTE WHEN 0 THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD)/ CTA02.COTIZ                                              ELSE ((CTA03.PRECIO_NET * CTA03.CANTIDAD) - ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_BONIF/100) +                                                           ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CTA02.IMPORTE_FL/(CTA02.IMPORTE-CTA02.IMPORTE_FL+CTA02.IMPORTE_BO-CTA02.IMPORTE_IV-CTA02.IMPORTE_IN-ISNULL(IMPUESTOS.IMPORTE,0))))                                                           + ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_RECARGO/100))  / CTA02.COTIZ END END                                        END                                   ELSE CASE 'NO' WHEN 'NO'                                   THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD)                                    ELSE CASE CTA02.IMPORTE WHEN 0 THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD)                                        ELSE ((CTA03.PRECIO_NET * CTA03.CANTIDAD) - ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_BONIF/100) +                                                           ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CTA02.IMPORTE_FL/(CTA02.IMPORTE-CTA02.IMPORTE_FL+CTA02.IMPORTE_BO-CTA02.IMPORTE_IV-CTA02.IMPORTE_IN-ISNULL(IMPUESTOS.IMPORTE,0)))) +                                                           ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_RECARGO/100))  END END                              END)  WHEN 'BICOTIZ'  THEN CASE 1  WHEN 0 THEN 0  ELSE   (CASE CTA02.MON_CTE WHEN 1 THEN CASE 'NO' WHEN 'NO'                                THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD)  / 1                                ELSE CASE CTA02.IMPORTE WHEN 0 THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD)  / 1                                      ELSE ((CTA03.PRECIO_NET * CTA03.CANTIDAD) - ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_BONIF/100) +                                     ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CTA02.IMPORTE_FL/(CTA02.IMPORTE-CTA02.IMPORTE_FL+CTA02.IMPORTE_BO-CTA02.IMPORTE_IV-CTA02.IMPORTE_IN-ISNULL(IMPUESTOS.IMPORTE,0)))) +                                     ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_RECARGO/100))                                                           / 1 END END                             ELSE CASE 'NO' WHEN 'NO'                              THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.COTIZ  / 1                                ELSE CASE CTA02.IMPORTE WHEN 0 THEN  (CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.COTIZ  / 1                                     ELSE ((CTA03.PRECIO_NET * CTA03.CANTIDAD) - ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_BONIF/100) +                                             ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CTA02.IMPORTE_FL/(CTA02.IMPORTE-CTA02.IMPORTE_FL+CTA02.IMPORTE_BO-CTA02.IMPORTE_IV-CTA02.IMPORTE_IN-ISNULL(IMPUESTOS.IMPORTE,0)))) +                                              ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_RECARGO/100)) * CTA02.COTIZ  / 1   END END                              END)  END END)) AS 'Detalle.IVA',
 	CONVERT(DECIMAL(18, 2), SUM (CASE CTA03.TCOMP_IN_V WHEN 'CC' THEN (-1) ELSE (1) END *      CASE  'BIMONCTE'          WHEN 'BIMONCTE' THEN  CASE CTA02.MON_CTE  WHEN 1 THEN CTA03.IMP_NETO_P ELSE  CTA03.IMP_NETO_P * CTA02.COTIZ END           WHEN 'BIORIGEN' THEN  CASE CTA02.MON_CTE  WHEN 1 THEN CASE CTA02.COTIZ WHEN 0 THEN 0 ELSE CTA03.IMP_NETO_P / CTA02.COTIZ END ELSE CTA03.IMP_NETO_P  END           WHEN 'BICOTIZ' THEN  CASE 1 WHEN 0 THEN 0 ELSE  CASE CTA02.MON_CTE  WHEN 1 THEN CTA03.IMP_NETO_P / 1 ELSE CTA03.IMP_NETO_P * CTA02.COTIZ / 1 END END END))  AS 'Detalle.Imp_sinImp' ,
 	CONVERT(DECIMAL(18, 2), SUM (CASE CTA03.TCOMP_IN_V WHEN 'CC' THEN (-1) ELSE (1) END *      CASE  'BIMONCTE'          WHEN 'BIMONCTE' THEN  CASE CTA02.MON_CTE  WHEN 1 THEN CTA03.IMP_NETO_P * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END) ELSE  CTA03.IMP_NETO_P * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END) * CTA02.COTIZ END           WHEN 'BIORIGEN' THEN  CASE CTA02.MON_CTE  WHEN 1 THEN CASE CTA02.COTIZ WHEN 0 THEN 0 ELSE CTA03.IMP_NETO_P * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END) / CTA02.COTIZ END ELSE CTA03.IMP_NETO_P * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END) END           WHEN 'BICOTIZ' THEN  CASE 1 WHEN 0 THEN 0 ELSE  CASE CTA02.MON_CTE  WHEN 1 THEN CTA03.IMP_NETO_P * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END) / 1 ELSE CTA03.IMP_NETO_P * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END) * CTA02.COTIZ / 1 END END END))  AS 'Detalle.ImpPropConIVA' ,
 	CONVERT(DECIMAL(18, 2), SUM( CASE WHEN CTA02.TCOMP_IN_V = 'CC' then (-1) ELSE (1) END *  CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN   (CASE CTA02.MON_CTE WHEN 1 THEN CASE 'NO' WHEN 'NO'                                   THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END)                                  ELSE ((CTA03.PRECIO_NET * CTA03.CANTIDAD) - ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_BONIF/100) +                                        ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CTA02.IMPORTE_FL/(CTA02.IMPORTE-CTA02.IMPORTE_FL+CTA02.IMPORTE_BO-CTA02.IMPORTE_IV-CTA02.IMPORTE_IN-ISNULL(IMPUESTOS.IMPORTE,0)))) + ((CTA03.PRECIO_NET * CTA03.CANTIDAD)                                        * CTA02.PORC_RECARGO/100))  * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END)  END                                   ELSE CASE 'NO' WHEN 'NO'                                   THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.COTIZ  * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END)                                  ELSE ((CTA03.PRECIO_NET * CTA03.CANTIDAD) - ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_BONIF/100) +                                        ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CTA02.IMPORTE_FL/(CTA02.IMPORTE-CTA02.IMPORTE_FL+CTA02.IMPORTE_BO-CTA02.IMPORTE_IV-CTA02.IMPORTE_IN-ISNULL(IMPUESTOS.IMPORTE,0)))) + ((CTA03.PRECIO_NET * CTA03.CANTIDAD)                                        * CTA02.PORC_RECARGO/100))  * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END) * CTA02.COTIZ END                              END)  WHEN 'BIORIGEN' THEN   (CASE CTA02.MON_CTE WHEN 1 THEN CASE CTA02.COTIZ WHEN 0                                   THEN 0                                   ELSE CASE 'NO' WHEN 'NO'                                        THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END) / CTA02.COTIZ                                         ELSE ((CTA03.PRECIO_NET * CTA03.CANTIDAD) - ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_BONIF/100) +                                                           ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CTA02.IMPORTE_FL/(CTA02.IMPORTE-CTA02.IMPORTE_FL+CTA02.IMPORTE_BO-CTA02.IMPORTE_IV-CTA02.IMPORTE_IN-ISNULL(IMPUESTOS.IMPORTE,0))))                                                           + ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_RECARGO/100)) * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END)  / CTA02.COTIZ END                                        END                                   ELSE CASE 'NO' WHEN 'NO'                                   THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END)                                   ELSE ((CTA03.PRECIO_NET * CTA03.CANTIDAD) - ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_BONIF/100) +                                                           ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CTA02.IMPORTE_FL/(CTA02.IMPORTE-CTA02.IMPORTE_FL+CTA02.IMPORTE_BO-CTA02.IMPORTE_IV-CTA02.IMPORTE_IN-ISNULL(IMPUESTOS.IMPORTE,0)))) +                                                           ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_RECARGO/100)) * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END) END                              END)  WHEN 'BICOTIZ'  THEN CASE 1  WHEN 0 THEN 0  ELSE   (CASE CTA02.MON_CTE WHEN 1 THEN CASE 'NO' WHEN 'NO'                                THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END) / 1                                ELSE ((CTA03.PRECIO_NET * CTA03.CANTIDAD) - ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_BONIF/100) +                                     ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CTA02.IMPORTE_FL/(CTA02.IMPORTE-CTA02.IMPORTE_FL+CTA02.IMPORTE_BO-CTA02.IMPORTE_IV-CTA02.IMPORTE_IN-ISNULL(IMPUESTOS.IMPORTE,0)))) +                                     ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_RECARGO/100))                                                          * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END) / 1 END                              ELSE CASE 'NO' WHEN 'NO'                              THEN (CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END) * CTA02.COTIZ  / 1                                ELSE ((CTA03.PRECIO_NET * CTA03.CANTIDAD) - ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_BONIF/100) +                                             ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * (CTA02.IMPORTE_FL/(CTA02.IMPORTE-CTA02.IMPORTE_FL+CTA02.IMPORTE_BO-CTA02.IMPORTE_IV-CTA02.IMPORTE_IN-ISNULL(IMPUESTOS.IMPORTE,0)))) +                                              ((CTA03.PRECIO_NET * CTA03.CANTIDAD) * CTA02.PORC_RECARGO/100)) * (CASE    WHEN CTA02.IMPORTE_IV = 0 THEN 1    ELSE ( 1 + (CTA03.PORC_IVA/100)) END) * CTA02.COTIZ  / 1   END                              END)  END END      ))  AS 'Detalle.ImporteConIVA' ,
 	cast(SUM(CASE CTA03.TCOMP_IN_V  WHEN 'CC'  THEN(-1)  ELSE(1)  END  * CTA03.CANTIDAD_2)as int) AS 'Detalle.Cantidad2',
	CAST(CTA03.PORC_IVA AS INT) AS 'Detalle.Alicuota',
	'Detalle.Rubro' = '1',
 	CTA03.N_RENGL_V as 'Detalle.N_RENGL_V'
 	FROM 
 	CTA03 (NOLOCK)  
 	INNER JOIN CTA02 (NOLOCK) ON 
 	(CTA02.N_COMP = CTA03.N_COMP AND CTA02.T_COMP = CTA03.T_COMP AND CTA03.NRO_SUCURS = CTA02.NRO_SUCURS)
	
 	LEFT JOIN CTA_ARTICULO (NOLOCK) ON 
 	CTA03.Cod_Articu = CTA_ARTICULO.COD_ARTICULO
	
 	LEFT JOIN CTA_MEDIDA (NOLOCK) ON 
 	CTA03.ID_MEDIDA_VENTAS = CTA_MEDIDA.ID_CTA_MEDIDA

 	LEFT JOIN(SELECT  NRO_SUCURS, T_COMP, N_COMP, SUM(IMPORTE) AS IMPORTE           FROM CTA04           WHERE (COD_IMPUES <>'') OR ( (COD_ALICUO BETWEEN 21 AND 80 ) OR COD_ALICUO = 82)           GROUP BY NRO_SUCURS, T_COMP, N_COMP) AS IMPUESTOS ON IMPUESTOS.T_COMP= CTA02.T_COMP AND IMPUESTOS.N_COMP = CTA02.N_COMP AND IMPUESTOS.NRO_SUCURS= CTA02.NRO_SUCURS 
	
 	LEFT JOIN CTA_ARTICULO (NOLOCK) CTA_ARTICULO2 ON CTA03.COD_ARTICU = CTA_ARTICULO2.COD_ARTICULO  
 	LEFT JOIN SUCURSAL (NOLOCK) SUCURSAL2 ON CTA03.NRO_SUCURS = SUCURSAL2.NRO_SUCURSAL  
 	LEFT JOIN CTA_DEPOSITO (NOLOCK) CTA_DEPOSITO2 ON CTA03.COD_DEPOSI = CTA_DEPOSITO2.COD_CTA_DEPOSITO  
 	LEFT JOIN  V_TN_SALDOS_STOCK_CENTRAL_BIS ON ( CTA_ARTICULO2.ID_CTA_ARTICULO = V_TN_SALDOS_STOCK_CENTRAL_BIS.ID_CTA_ARTICULO  AND CTA_DEPOSITO2.ID_CTA_DEPOSITO = V_TN_SALDOS_STOCK_CENTRAL_BIS.ID_CTA_DEPOSITO  AND  SUCURSAL2.ID_SUCURSAL = V_TN_SALDOS_STOCK_CENTRAL_BIS.ID_SUCURSAL)


 	WHERE 
	CTA03.FECHA_MOV >= DATEADD(DAY, -5, GETDATE()) and
 	CTA03.Cod_Articu NOT IN ('Art. Ajuste') AND (CTA03.Cod_Articu <> '') AND CTA02.T_COMP <> 'REC'
 	AND ((isnull(CTA03.RENGL_PADR,0) = 0) OR (isnull(CTA03.INSUMO_KIT_SEPARADO,0) = 1)) AND CTA02.Nro_Sucurs IN ( '10' )
	--AND CTA02.N_COMP = @NCOMP


 	GROUP BY 
 		CTA02.N_COMP ,CTA03.FECHA_MOV , SUBSTRING(cta02.HORA_EMIS, 1, 2) + ':' + SUBSTRING(cta02.HORA_EMIS, 3, 2) + ':' + SUBSTRING(cta02.HORA_EMIS, 5, 2) , CTA02.T_COMP , CTA02.NRO_SUCURS , CTA_ARTICULO.DESC_CTA_ARTICULO , CTA03.Cod_Articu , CTA03.PORC_DTO , CTA_ARTICULO.COMISION_V , CTA_ARTICULO.DESCUENTO , CTA_MEDIDA.SIGLA_MEDIDA , CTA03.PRECIO_NET ,  CASE CTA03.TCOMP_IN_V WHEN 'CC' THEN ( -1 )ELSE ( 1 ) END * CASE 'BIMONCTE' WHEN 'BIMONCTE' THEN CASE CTA02.MON_CTE  WHEN 1 THEN CTA03.PRECIO_NET * (CASE WHEN CTA02.IMPORTE_IV = 0 THEN 1 ELSE ( 1 + (CTA03.PORC_IVA/100)) END) ELSE  CTA03.PRECIO_NET * (CASE WHEN CTA02.IMPORTE_IV = 0 THEN 1 ELSE ( 1 + (CTA03.PORC_IVA/100)) END) * CTA02.COTIZ  END WHEN 'BIORIGEN' THEN CASE CTA02.MON_CTE  WHEN 1 THEN CASE CTA02.COTIZ WHEN 0 THEN 0 ELSE CTA03.PRECIO_NET  * (CASE WHEN CTA02.IMPORTE_IV = 0 THEN 1 ELSE ( 1 + (CTA03.PORC_IVA/100)) END) /CTA02.COTIZ END ELSE CTA03.PRECIO_NET  * (CASE WHEN CTA02.IMPORTE_IV = 0 THEN 1 ELSE ( 1 + (CTA03.PORC_IVA/100)) END) END WHEN 'BICOTIZ' THEN CASE 1 WHEN 0 THEN 0 ELSE CASE CTA02.MON_CTE WHEN 1 THEN  CTA03.PRECIO_NET * (CASE WHEN CTA02.IMPORTE_IV = 0 THEN 1 ELSE ( 1 + (CTA03.PORC_IVA/100)) END) ELSE CTA03.PRECIO_NET *  (CASE WHEN CTA02.IMPORTE_IV = 0 THEN 1 ELSE ( 1 + (CTA03.PORC_IVA/100)) END) * CTA02.COTIZ END / 1 END END,
 		CTA03.N_RENGL_V, CTA03.PORC_IVA) as vtaDetalle
	--FOR JSON PATH
'''